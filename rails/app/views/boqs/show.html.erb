<div class="container mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold"><%= @boq.boq_name %></h1>
      <p class="text-gray-600 mt-1">
        <% if @boq.client_name %>
          <%= @boq.client_name %> 
          <% if @boq.client_reference %> · <%= @boq.client_reference %><% end %>
        <% end %>
      </p>
    </div>
    <%= link_to "Back to BOQs", boqs_path, class: "btn btn-ghost" %>
  </div>

  <!-- BOQ Metadata -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">BOQ Details</h3>
        <div class="space-y-2 text-sm">
          <div><span class="font-medium">File:</span> <%= @boq.file_name %></div>
          <div><span class="font-medium">Status:</span> <span class="badge <%= @boq.status == 'parsed' ? 'badge-success' : 'badge-warning' %>"><%= @boq.status %></span></div>
          <div><span class="font-medium">Received:</span> <%= @boq.received_date&.to_formatted_s(:short) || "—" %></div>
          <div><span class="font-medium">Uploaded By:</span> <%= @boq.uploaded_by&.name || "—" %></div>
          <% if @boq.parsed_at %>
            <div><span class="font-medium">Parsed:</span> <%= @boq.parsed_at.to_formatted_s(:short) %></div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">QS & Client Info</h3>
        <div class="space-y-2 text-sm">
          <% if @boq.qs_name %>
            <div><span class="font-medium">Quantity Surveyor:</span> <%= @boq.qs_name %></div>
          <% else %>
            <div class="text-gray-500">No QS name provided</div>
          <% end %>
        </div>
        <% if @boq.notes %>
          <div class="mt-3 text-sm bg-blue-50 p-2 rounded border border-blue-200">
            <span class="font-medium">Notes:</span> <%= simple_format(@boq.notes) %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- CSV Preview & Download -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h3 class="card-title text-lg">
          <i class="fas fa-file-csv"></i>
          CSV File
        </h3>
        <% if @boq.csv_file.attached? %>
          <%= link_to "Download", rails_blob_path(@boq.csv_file, disposition: "attachment"), class: "btn btn-sm btn-outline" %>
        <% end %>
      </div>

      <!-- CSV Preview -->
      <% if @boq.csv_file.attached? %>
        <div class="bg-gray-50 rounded border border-gray-200 p-4 overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm text-xs">
            <% 
              csv_content = @boq.csv_file.download
              csv_lines = csv_content.split("\n").first(20)
              csv_lines.each_with_index do |line, idx|
                columns = line.strip.split(',').map(&:strip)
            %>
              <% if idx == 0 %>
                <thead>
                  <tr>
                    <% columns.each do |col| %>
                      <th><%= col %></th>
                    <% end %>
                  </tr>
                </thead>
              <% else %>
                <% if idx == 1 %>
                  <tbody>
                <% end %>
                <tr>
                  <% columns.each do |col| %>
                    <td><%= col %></td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
            </tbody>
          </table>
          <% 
            total_rows = csv_content.split("\n").count
            if total_rows > 20
          %>
            <div class="text-xs text-gray-500 mt-3 text-center">
              Showing first 20 rows of <%= total_rows %> total rows
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>No CSV file attached yet</div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- AI BOQ Parser Chat Interface -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <i class="fas fa-robot"></i>
        AI BOQ Parser Assistant
      </h2>
      <p class="text-sm text-gray-600 mb-4">
        Chat with our AI assistant to parse the CSV file and automatically create line items. 
        The AI will analyze the file structure and help you organize the data.
      </p>
      
      <!-- Chat Container -->
      <div id="boq-parser-chat" class="bg-gray-50 rounded border border-gray-200 p-4 mb-4" style="height: 400px; overflow-y: auto; display: flex; flex-direction: column;">
        <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 mb-4">
          <!-- Messages will be inserted here -->
          <div class="chat chat-start">
            <div class="chat-bubble chat-bubble-primary">
              <i class="fas fa-robot mr-2"></i>
              <span>Hi! I'm ready to help parse your BOQ file. You can ask me to:</span>
              <ul class="text-sm mt-2 ml-4 list-disc">
                <li>Analyze the CSV structure</li>
                <li>Parse and extract line items</li>
                <li>Update BOQ metadata</li>
                <li>Organize items by category</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Input Area -->
        <div class="flex gap-2">
          <input 
            type="text" 
            id="chat-input" 
            placeholder="Ask the AI to parse the BOQ... (e.g., 'Parse the CSV and create line items')"
            class="input input-bordered flex-1 input-sm"
            onkeypress="handleChatKeypress(event)"
          >
          <button 
            onclick="sendChatMessage()"
            class="btn btn-primary btn-sm"
          >
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="flex flex-wrap gap-2">
        <button 
          onclick="sendQuickPrompt('Analyze the CSV file structure and tell me what columns and data you find.')"
          class="btn btn-sm btn-outline"
        >
          <i class="fas fa-search"></i> Analyze Structure
        </button>
        <button 
          onclick="sendQuickPrompt('Parse the entire CSV file and create all line items with proper categorization.')"
          class="btn btn-sm btn-outline"
        >
          <i class="fas fa-wand-magic-2"></i> Auto-Parse
        </button>
      </div>
    </div>
  </div>

  <!-- BOQ Items -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <i class="fas fa-list"></i>
        BOQ Line Items
        <span class="badge badge-lg"><%= @boq_items.count %></span>
      </h2>

      <% if @boq_items.any? %>
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr>
                <th>#</th>
                <th>Item Number</th>
                <th>Description</th>
                <th>Category</th>
                <th>UOM</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody>
              <% @boq_items.each_with_index do |item, idx| %>
                <tr>
                  <td><%= idx + 1 %></td>
                  <td class="font-mono text-sm"><%= item.item_number || "—" %></td>
                  <td>
                    <div class="text-sm"><%= truncate(item.item_description, length: 60) %></div>
                    <% if item.notes %>
                      <div class="text-xs text-gray-500 mt-1"><%= item.notes %></div>
                    <% end %>
                  </td>
                  <td><span class="badge badge-sm"><%= item.section_category || "—" %></span></td>
                  <td><%= item.unit_of_measure || "—" %></td>
                  <td class="text-right font-semibold"><%= item.quantity || "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>No line items yet. Parse the BOQ to extract items.</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
// LangGraph Chat Interface for BOQ Parser
class BoqParserChat {
  constructor(boqId) {
    this.boqId = boqId;
    this.threadId = null;
    this.messagesContainer = document.getElementById('chat-messages');
    this.chatInput = document.getElementById('chat-input');
    this.isWaitingForResponse = false;
  }

  async initialize() {
    // Get or create thread ID for this session
    this.threadId = `boq_${this.boqId}_${Date.now()}`;
    this.addSystemMessage('Connected to BOQ Parser Agent. Ready to parse your CSV file!');
  }

  addMessage(content, role = 'user') {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat chat-${role === 'user' ? 'end' : 'start'}`;
    
    const bubbleClass = role === 'user' ? 'chat-bubble-info' : 'chat-bubble-primary';
    messageDiv.innerHTML = `
      <div class="chat-bubble ${bubbleClass}">
        ${this.escapeHtml(content)}
      </div>
    `;
    
    this.messagesContainer.appendChild(messageDiv);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  addSystemMessage(content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat chat-start';
    messageDiv.innerHTML = `
      <div class="chat-bubble chat-bubble-primary">
        <i class="fas fa-robot mr-2"></i>
        ${this.escapeHtml(content)}
      </div>
    `;
    
    this.messagesContainer.appendChild(messageDiv);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  addLoadingMessage() {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat chat-start';
    messageDiv.id = 'loading-message';
    messageDiv.innerHTML = `
      <div class="chat-bubble chat-bubble-primary">
        <span class="loading loading-spinner loading-sm"></span>
        <span class="ml-2">Parsing...</span>
      </div>
    `;
    
    this.messagesContainer.appendChild(messageDiv);
    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
  }

  removeLoadingMessage() {
    const loadingMsg = document.getElementById('loading-message');
    if (loadingMsg) {
      loadingMsg.remove();
    }
  }

  escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  async sendMessage(userMessage) {
    if (!userMessage.trim() || this.isWaitingForResponse) return;

    // Display user message
    this.addMessage(userMessage, 'user');
    this.chatInput.value = '';
    
    // Show loading indicator
    this.addLoadingMessage();
    this.isWaitingForResponse = true;

    try {
      // Send to LlamaBotRails chat channel via WebSocket
      const response = await this.sendToAgent(userMessage);
      
      this.removeLoadingMessage();
      
      // Handle response
      if (response && response.message) {
        this.addSystemMessage(response.message);
      }
      
      // Check if there were any errors
      if (response && response.error) {
        this.addSystemMessage(`Error: ${response.error}`);
      }
    } catch (error) {
      this.removeLoadingMessage();
      console.error('Chat error:', error);
      this.addSystemMessage(`Error: ${error.message}`);
    } finally {
      this.isWaitingForResponse = false;
      this.chatInput.focus();
    }
  }

  async sendToAgent(message) {
    // Connect to LlamaBotRails WebSocket channel
    // This assumes you have a chat interface integrated with LlamaBotRails
    return new Promise((resolve, reject) => {
      // Build the message payload
      const payload = {
        message: message,
        raw_params: {
          boq_id: this.boqId,
          controller: 'boqs',
          action: 'show'
        }
      };

      // Send via fetch API to Rails backend
      // The backend will route this through the LlamaBotRails chat channel
      fetch(`/boqs/${this.boqId}/chat`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => resolve(data))
      .catch(error => reject(error));
    });
  }
}

// Initialize chat when page loads
let boqChat = null;

document.addEventListener('DOMContentLoaded', async function() {
  const boqId = <%= @boq.id %>;
  boqChat = new BoqParserChat(boqId);
  await boqChat.initialize();
});

// Send message on button click or Enter key
function sendChatMessage() {
  if (boqChat) {
    const message = document.getElementById('chat-input').value;
    boqChat.sendMessage(message);
  }
}

function handleChatKeypress(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendChatMessage();
  }
}

function sendQuickPrompt(prompt) {
  if (boqChat) {
    boqChat.sendMessage(prompt);
  }
}
</script>

