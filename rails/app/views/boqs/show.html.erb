<div class="container mx-auto p-6">
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-3xl font-bold"><%= @boq.boq_name %></h1>
      <p class="text-gray-600 mt-1">
        <% if @boq.client_name %>
          <%= @boq.client_name %> 
          <% if @boq.client_reference %> ¬∑ <%= @boq.client_reference %><% end %>
        <% end %>
      </p>
    </div>
    <%= link_to "Back to BOQs", boqs_path, class: "btn btn-ghost" %>
  </div>

  <!-- BOQ Metadata -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">BOQ Details</h3>
        <div class="space-y-2 text-sm">
          <div><span class="font-medium">File:</span> <%= @boq.file_name %></div>
          <div><span class="font-medium">Status:</span> <span class="badge <%= @boq.status == 'parsed' ? 'badge-success' : 'badge-warning' %>"><%= @boq.status %></span></div>
          <div><span class="font-medium">Received:</span> <%= @boq.received_date&.to_formatted_s(:short) || "‚Äî" %></div>
          <div><span class="font-medium">Uploaded By:</span> <%= @boq.uploaded_by&.name || "‚Äî" %></div>
          <% if @boq.parsed_at %>
            <div><span class="font-medium">Parsed:</span> <%= @boq.parsed_at.to_formatted_s(:short) %></div>
          <% end %>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-sm">
      <div class="card-body p-4">
        <h3 class="font-semibold text-sm mb-2">QS & Client Info</h3>
        <div class="space-y-2 text-sm">
          <% if @boq.qs_name %>
            <div><span class="font-medium">Quantity Surveyor:</span> <%= @boq.qs_name %></div>
          <% else %>
            <div class="text-gray-500">No QS name provided</div>
          <% end %>
        </div>
        <% if @boq.notes %>
          <div class="mt-3 text-sm bg-blue-50 p-2 rounded border border-blue-200">
            <span class="font-medium">Notes:</span> <%= simple_format(@boq.notes) %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- CSV Preview & Download -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h3 class="card-title text-lg">
          <i class="fas fa-file-csv"></i>
          CSV File
        </h3>
        <% if @boq.csv_file.attached? %>
          <%= link_to "Download", rails_blob_path(@boq.csv_file, disposition: "attachment"), class: "btn btn-sm btn-outline" %>
        <% end %>
      </div>

      <!-- CSV Preview -->
      <% if @boq.csv_file.attached? %>
        <div class="bg-gray-50 rounded border border-gray-200 p-4 overflow-x-auto" style="max-height: 400px; overflow-y: auto;">
          <table class="table table-sm text-xs">
            <% 
              csv_content = @boq.csv_file.download
              csv_lines = csv_content.split("\n").first(20)
              csv_lines.each_with_index do |line, idx|
                columns = line.strip.split(',').map(&:strip)
            %>
              <% if idx == 0 %>
                <thead>
                  <tr>
                    <% columns.each do |col| %>
                      <th><%= col %></th>
                    <% end %>
                  </tr>
                </thead>
              <% else %>
                <% if idx == 1 %>
                  <tbody>
                <% end %>
                <tr>
                  <% columns.each do |col| %>
                    <td><%= col %></td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
            </tbody>
          </table>
          <% 
            total_rows = csv_content.split("\n").count
            if total_rows > 20
          %>
            <div class="text-xs text-gray-500 mt-3 text-center">
              Showing first 20 rows of <%= total_rows %> total rows
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>No CSV file attached yet</div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- AI BOQ Parser Chat Interface (LlamaBot) -->
  <div class="card bg-base-100 shadow-sm mb-6">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <i class="fas fa-robot"></i>
        AI BOQ Parser Assistant
      </h2>
      <p class="text-sm text-gray-600 mb-4">
        Chat with our AI assistant to parse the CSV file and automatically create line items. 
        The AI will analyze the file structure and help you organize the data.
      </p>
      
      <!-- LlamaBot Chat Container -->
      <div data-llamabot="chat-container" class="flex flex-col border border-gray-200 rounded-lg bg-white overflow-hidden" style="height: 500px;">
        <!-- Header -->
        <div class="flex items-center justify-between bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200 p-4">
          <div class="flex items-center gap-2">
            <i class="fas fa-robot text-indigo-600"></i>
            <span class="font-semibold text-gray-800">BOQ Parser</span>
          </div>
          <div data-llamabot="connection-status" class="h-3 w-3 rounded-full bg-green-400 animate-pulse"></div>
        </div>

        <!-- Message History -->
        <div data-llamabot="message-history" class="flex-grow overflow-y-auto p-4 bg-gray-50"></div>

        <!-- Thinking Area -->
        <div data-llamabot="thinking-area" class="hidden bg-blue-50 border-t border-blue-200 px-4 py-3 text-sm text-blue-700"></div>

        <!-- Input Area -->
        <div class="border-t border-gray-200 bg-white p-4 flex gap-2">
          <input 
            data-llamabot="message-input" 
            type="text" 
            placeholder="Ask the AI to parse the BOQ..." 
            class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm"
          />
          <button 
            data-llamabot="send-button" 
            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors flex items-center gap-2"
            disabled
          >
            <i class="fas fa-paper-plane"></i>
            <span class="hidden sm:inline">Send</span>
          </button>
        </div>
      </div>

      <!-- Quick Actions / Suggested Prompts -->
      <div class="mt-4 pt-4 border-t border-gray-200">
        <div class="text-xs font-semibold text-gray-600 mb-3 uppercase tracking-wide">Quick Actions</div>
        <div class="flex flex-wrap gap-2">
          <button 
            data-llamabot="suggested-prompt"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors"
          >
            <i class="fas fa-search mr-1"></i> Analyze Structure
          </button>
          <button 
            data-llamabot="suggested-prompt"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors"
          >
            <i class="fas fa-wand-magic-2 mr-1"></i> Auto-Parse All Items
          </button>
          <button 
            data-llamabot="suggested-prompt"
            class="px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-full transition-colors"
          >
            <i class="fas fa-tags mr-1"></i> Categorize Items
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- BOQ Items -->
  <div class="card bg-base-100 shadow">
    <div class="card-body">
      <h2 class="card-title mb-4">
        <i class="fas fa-list"></i>
        BOQ Line Items
        <span class="badge badge-lg"><%= @boq_items.count %></span>
      </h2>

      <% if @boq_items.any? %>
        <div class="overflow-x-auto">
          <table class="table table-sm w-full">
            <thead>
              <tr>
                <th>#</th>
                <th>Item Number</th>
                <th>Description</th>
                <th>Category</th>
                <th>UOM</th>
                <th>Quantity</th>
              </tr>
            </thead>
            <tbody>
              <% @boq_items.each_with_index do |item, idx| %>
                <tr>
                  <td><%= idx + 1 %></td>
                  <td class="font-mono text-sm"><%= item.item_number || "‚Äî" %></td>
                  <td>
                    <div class="text-sm"><%= truncate(item.item_description, length: 60) %></div>
                    <% if item.notes %>
                      <div class="text-xs text-gray-500 mt-1"><%= item.notes %></div>
                    <% end %>
                  </td>
                  <td><span class="badge badge-sm"><%= item.section_category || "‚Äî" %></span></td>
                  <td><%= item.unit_of_measure || "‚Äî" %></td>
                  <td class="text-right font-semibold"><%= item.quantity || "‚Äî" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>No line items yet. Parse the BOQ to extract items.</div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script type="module">
  console.log('üöÄ BOQ Chat: Initializing...');

  // Wait for ActionCable to be available, then initialize LlamaBot chat
  function waitForCableConnection(callback, maxWaitMs = 10000) {
    const startTime = Date.now();
    
    const interval = setInterval(() => {
      const elapsed = Date.now() - startTime;
      
      if (window.LlamaBotRails && window.LlamaBotRails.cable) {
        console.log('‚úÖ BOQ Chat: ActionCable ready');
        clearInterval(interval);
        callback(window.LlamaBotRails.cable);
      } else if (elapsed > maxWaitMs) {
        console.error('‚ùå BOQ Chat: ActionCable timeout after', maxWaitMs, 'ms');
        console.error('window.LlamaBotRails:', window.LlamaBotRails);
        clearInterval(interval);
      }
    }, 50);
  }

  async function initializeChat() {
    try {
      console.log('üì¶ BOQ Chat: Loading LlamaBot library from S3...');
      const cdnUrl = 'https://llamapress-cdn.s3.amazonaws.com/llamabot-chat-js-v0.2.19/index.js';
      console.log('üìç CDN URL:', cdnUrl);
      
      try {
        // Test CDN availability with a fetch first
        console.log('üîç Testing CDN connectivity...');
        const headResponse = await fetch(cdnUrl, { method: 'HEAD' });
        console.log('üåê CDN HEAD response status:', headResponse.status);
      } catch (fetchError) {
        console.warn('‚ö†Ô∏è CDN HEAD request failed (this may be okay):', fetchError.message);
      }
      
      // Import LlamaBot chat from S3 CDN
      console.log('üì• Attempting dynamic import...');
      let LlamaBot;
      try {
        const module = await import(cdnUrl);
        LlamaBot = module.default;
        console.log('‚úÖ BOQ Chat: LlamaBot library loaded successfully');
        console.log('LlamaBot object:', LlamaBot);
        console.log('LlamaBot.create:', typeof LlamaBot?.create);
      } catch (importError) {
        console.error('‚ùå Import failed with error:', importError);
        console.error('Error name:', importError.name);
        console.error('Error message:', importError.message);
        console.error('Error stack:', importError.stack);
        
        // Check if it's a CORS issue
        if (importError.message.includes('CORS') || importError.message.includes('Failed to fetch')) {
          console.error('üö® Likely CORS or network issue - CDN might be unreachable');
        }
        throw importError;
      }

      // Extract BOQ ID from current page URL
      const pathParts = window.location.pathname.split('/');
      const boqId = pathParts[pathParts.length - 1];
      console.log('BOQ ID extracted:', boqId);

      console.log('‚è≥ BOQ Chat: Waiting for ActionCable...');
      waitForCableConnection((consumer) => {
        try {
          console.log('üîå BOQ Chat: Initializing chat with consumer:', consumer);
          console.log('üìã LlamaBot.create type:', typeof LlamaBot.create);

          // Initialize the chat interface
          try {
            console.log('üéØ Calling LlamaBot.create with config...');
            const config = {
              actionCable: {
                consumer: consumer,
                channel: 'LlamaBotRails::ChatChannel',
                session_id: crypto.randomUUID(),
                raw_params: {
                  boq_id: boqId
                }
              },
              agent: {
                name: 'boq_parser'  // Must match the key in langgraph.json
              },
              // Tailwind CSS classes for styling
              cssClasses: {
                humanMessage: 'bg-indigo-100 text-indigo-900 p-3 rounded-lg mb-2 max-w-xs',
                aiMessage: 'bg-blue-50 text-gray-900 p-3 rounded-lg mb-2 max-w-2xl prose prose-sm',
                errorMessage: 'bg-red-100 text-red-800 p-3 rounded-lg mb-2 max-w-xs',
                connectionStatusConnected: 'h-3 w-3 rounded-full bg-green-400 animate-pulse',
                connectionStatusDisconnected: 'h-3 w-3 rounded-full bg-red-400'
              }
            };
            console.log('üìù Config:', config);
            
            const chat = LlamaBot.create('[data-llamabot="chat-container"]', config);
            console.log('‚úÖ BOQ Chat: Initialized successfully');
            console.log('Chat instance:', chat);
          } catch (createError) {
            console.error('‚ùå BOQ Chat: LlamaBot.create error:', createError);
            console.error('Error name:', createError.name);
            console.error('Error message:', createError.message);
            console.error('Stack:', createError.stack);
            throw createError;
          }
        } catch (error) {
          console.error('‚ùå BOQ Chat: Callback error:', error);
          console.error('Stack:', error.stack);
        }
      });
    } catch (error) {
      console.error('‚ùå BOQ Chat: Library import error:', error);
      console.error('Stack:', error.stack);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChat);
  } else {
    initializeChat();
  }
</script>

